<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Storage æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-input {
            margin-bottom: 15px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .log-entry {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .log-entry.success {
            color: #4ec9b0;
        }

        .log-entry.error {
            color: #f48771;
        }

        .log-entry.info {
            color: #9cdcfe;
        }

        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ Supabase Storage æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯• Supabase Storage å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½</p>

        <!-- è¿æ¥æµ‹è¯• -->
        <div class="test-section">
            <h2>1. è¿æ¥æµ‹è¯•</h2>
            <div id="connectionStatus" class="status info">æ­£åœ¨æµ‹è¯•è¿æ¥...</div>
        </div>

        <!-- Storage Bucket æµ‹è¯• -->
        <div class="test-section">
            <h2>2. Storage Bucket æµ‹è¯•</h2>
            <button id="testBucketBtn" class="button">æµ‹è¯• Bucket è®¿é—®</button>
            <div id="bucketStatus"></div>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼ æµ‹è¯• -->
        <div class="test-section">
            <h2>3. å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</h2>
            <input type="file" id="fileInput" accept="image/*" class="file-input">
            <br>
            <button id="uploadBtn" class="button" disabled>ä¸Šä¼ å›¾ç‰‡</button>
            <div id="uploadStatus"></div>
            <img id="imagePreview" class="image-preview" style="display: none;">
        </div>

        <!-- æ•°æ®åº“è¡¨ç»“æ„æµ‹è¯• -->
        <div class="test-section">
            <h2>4. æ•°æ®åº“è¡¨ç»“æ„æµ‹è¯•</h2>
            <button id="testTableBtn" class="button">æ£€æŸ¥ images å­—æ®µ</button>
            <div id="tableStatus"></div>
        </div>

        <!-- æ“ä½œæ—¥å¿— -->
        <div class="test-section">
            <h2>æ“ä½œæ—¥å¿—</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase configuration - Supabase é…ç½®
        const SUPABASE_URL = 'https://vswrhnmhumfxgfrwpfwc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzd3Jobm1odW1meGdmcndwZndjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2NDU2NDMsImV4cCI6MjA3ODIyMTY0M30.LRkpH5Wp-w9BOwD-CUJ3Yz9G_5Us0fkjBgKN3zdcL2s';

        let supabase = null;
        let uploadedFilePath = null;

        // Initialize - åˆå§‹åŒ–
        function init() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                testConnection();
            } catch (error) {
                addLog('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                setStatus('connectionStatus', 'Supabase åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // Test connection - æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                const { data, error } = await supabase.from('cats').select('count').limit(1);

                if (error) {
                    throw error;
                }

                setStatus('connectionStatus', 'âœ“ Supabase è¿æ¥æˆåŠŸ', 'success');
                addLog('Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                document.getElementById('uploadBtn').disabled = false;
            } catch (error) {
                setStatus('connectionStatus', 'âœ— è¿æ¥å¤±è´¥: ' + error.message, 'error');
                addLog('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Test bucket access - æµ‹è¯• Bucket è®¿é—®
        async function testBucket() {
            addLog('æµ‹è¯• Storage Bucket...', 'info');
            addLog('æ³¨æ„: anon key æ— æ³•åˆ—å‡ºæ‰€æœ‰ bucketsï¼Œè¿™æ˜¯æ­£å¸¸çš„å®‰å…¨é™åˆ¶', 'info');

            try {
                // Try to list files in cat-images bucket directly
                // ç›´æ¥å°è¯•åˆ—å‡º cat-images bucket ä¸­çš„æ–‡ä»¶
                const { data: files, error: listError } = await supabase.storage
                    .from('cat-images')
                    .list('', { limit: 10 });

                if (listError) {
                    // Check error type - æ£€æŸ¥é”™è¯¯ç±»å‹
                    if (listError.message.includes('not found') || listError.message.includes('does not exist')) {
                        setStatus('bucketStatus', 'âœ— cat-images Bucket ä¸å­˜åœ¨ï¼Œè¯·å…ˆåˆ›å»º', 'error');
                        addLog('âœ— cat-images Bucket ä¸å­˜åœ¨', 'error');
                        addLog('è¯·åœ¨ Supabase Dashboard > Storage ä¸­åˆ›å»º cat-images bucket', 'info');
                        addLog('é”™è¯¯è¯¦æƒ…: ' + listError.message, 'error');
                    } else if (listError.message.includes('permission') || listError.message.includes('policy')) {
                        setStatus('bucketStatus', 'âš ï¸ Bucket å­˜åœ¨ä½†ç¼ºå°‘è®¿é—®ç­–ç•¥', 'error');
                        addLog('âš ï¸ cat-images Bucket å­˜åœ¨ä½†æƒé™é…ç½®ä¸æ­£ç¡®', 'error');
                        addLog('è¯·åœ¨ SQL Editor ä¸­æ‰§è¡Œ Storage ç­–ç•¥é…ç½®', 'info');
                        addLog('é”™è¯¯è¯¦æƒ…: ' + listError.message, 'error');
                    } else {
                        throw listError;
                    }
                    return;
                }

                // Success - æˆåŠŸ
                setStatus('bucketStatus', 'âœ“ cat-images Bucket å·²åˆ›å»ºå¹¶å¯è®¿é—®', 'success');
                addLog('âœ“ cat-images Bucket å­˜åœ¨ä¸”å¯è®¿é—®', 'success');
                addLog(`âœ“ Bucket ä¸­æœ‰ ${files.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`, 'info');

                // Show some file info if exists - æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                if (files.length > 0) {
                    addLog('æ–‡ä»¶åˆ—è¡¨:', 'info');
                    files.slice(0, 5).forEach(file => {
                        addLog(`  - ${file.name} (${file.id || 'folder'})`, 'info');
                    });
                    if (files.length > 5) {
                        addLog(`  ... è¿˜æœ‰ ${files.length - 5} ä¸ªæ–‡ä»¶`, 'info');
                    }
                } else {
                    addLog('Bucket æ˜¯ç©ºçš„ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰', 'info');
                }

            } catch (error) {
                setStatus('bucketStatus', 'âœ— æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                addLog('Bucket æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                addLog('è¯·æ£€æŸ¥:', 'info');
                addLog('1. Bucket åç§°æ˜¯å¦ä¸º cat-images', 'info');
                addLog('2. Bucket æ˜¯å¦è®¾ç½®ä¸º Public', 'info');
                addLog('3. Storage ç­–ç•¥æ˜¯å¦å·²é…ç½®', 'info');
            }
        }

        // Upload image - ä¸Šä¼ å›¾ç‰‡
        async function uploadImage() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶');
                return;
            }

            addLog(`å¼€å§‹ä¸Šä¼ å›¾ç‰‡: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');
            addLog(`æ–‡ä»¶ç±»å‹: ${file.type}`, 'info');
            setStatus('uploadStatus', 'æ­£åœ¨ä¸Šä¼ ...', 'info');

            try {
                // Generate unique filename - ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                const timestamp = Date.now();
                const fileExt = file.name.split('.').pop();
                const randomStr = Math.random().toString(36).substring(7);
                const fileName = `test/${timestamp}_${randomStr}.${fileExt}`;

                addLog(`æ–‡ä»¶è·¯å¾„: ${fileName}`, 'info');
                addLog(`Bucket: cat-images`, 'info');

                // Upload file - ä¸Šä¼ æ–‡ä»¶
                addLog('è°ƒç”¨ supabase.storage.from("cat-images").upload()...', 'info');
                const { data, error } = await supabase.storage
                    .from('cat-images')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                addLog('ä¸Šä¼ è¯·æ±‚è¿”å›', 'info');

                if (error) {
                    addLog(`é”™è¯¯å¯¹è±¡: ${JSON.stringify(error, null, 2)}`, 'error');
                    throw error;
                }

                if (data) {
                    addLog(`ä¸Šä¼ è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
                }

                uploadedFilePath = fileName;
                addLog('âœ“ æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');

                // Get public URL - è·å–å…¬å¼€ URL
                addLog('è·å–å…¬å¼€ URL...', 'info');
                const { data: urlData } = supabase.storage
                    .from('cat-images')
                    .getPublicUrl(fileName);

                const publicUrl = urlData.publicUrl;
                addLog(`å…¬å¼€ URL: ${publicUrl}`, 'success');

                setStatus('uploadStatus', 'âœ“ ä¸Šä¼ æˆåŠŸï¼', 'success');

                // Show preview - æ˜¾ç¤ºé¢„è§ˆ
                const preview = document.getElementById('imagePreview');
                preview.src = publicUrl;
                preview.style.display = 'block';

                preview.onload = () => {
                    addLog('âœ“ å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                };

                preview.onerror = () => {
                    addLog('âœ— å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ CORS é—®é¢˜æˆ–æ–‡ä»¶ä¸å­˜åœ¨', 'error');
                };

                // Add delete button - æ·»åŠ åˆ é™¤æŒ‰é’®
                const uploadStatus = document.getElementById('uploadStatus');
                uploadStatus.innerHTML += '<br><button class="button" onclick="deleteUploadedImage()">åˆ é™¤æµ‹è¯•å›¾ç‰‡</button>';

            } catch (error) {
                setStatus('uploadStatus', 'âœ— ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                addLog('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');

                // Log full error object - è®°å½•å®Œæ•´é”™è¯¯å¯¹è±¡
                addLog('å®Œæ•´é”™è¯¯ä¿¡æ¯:', 'error');
                addLog(JSON.stringify(error, null, 2), 'error');

                if (error.message.includes('not found')) {
                    addLog('å¯èƒ½åŸå› : cat-images bucket ä¸å­˜åœ¨', 'error');
                } else if (error.message.includes('permission') || error.message.includes('policy')) {
                    addLog('å¯èƒ½åŸå› : Storage ç­–ç•¥æœªæ­£ç¡®é…ç½®', 'error');
                } else if (error.message.includes('already exists')) {
                    addLog('å¯èƒ½åŸå› : æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                }
            }
        }

        // Delete uploaded image - åˆ é™¤ä¸Šä¼ çš„å›¾ç‰‡
        async function deleteUploadedImage() {
            if (!uploadedFilePath) {
                alert('æ²¡æœ‰è¦åˆ é™¤çš„å›¾ç‰‡');
                return;
            }

            addLog(`åˆ é™¤å›¾ç‰‡: ${uploadedFilePath}`, 'info');

            try {
                const { error } = await supabase.storage
                    .from('cat-images')
                    .remove([uploadedFilePath]);

                if (error) {
                    throw error;
                }

                addLog('âœ“ å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
                document.getElementById('imagePreview').style.display = 'none';
                uploadedFilePath = null;
                setStatus('uploadStatus', 'âœ“ æµ‹è¯•å›¾ç‰‡å·²åˆ é™¤', 'success');

            } catch (error) {
                addLog('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Test table structure - æµ‹è¯•è¡¨ç»“æ„
        async function testTable() {
            addLog('æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„...', 'info');

            try {
                // Try to query with images field - å°è¯•æŸ¥è¯¢ images å­—æ®µ
                const { data, error } = await supabase
                    .from('cats')
                    .select('id, name, images')
                    .limit(3);

                if (error) {
                    throw error;
                }

                setStatus('tableStatus', 'âœ“ images å­—æ®µå­˜åœ¨ä¸”å¯è®¿é—®', 'success');
                addLog('âœ“ images å­—æ®µå·²æ­£ç¡®æ·»åŠ åˆ° cats è¡¨', 'success');
                addLog(`æŸ¥è¯¢åˆ° ${data.length} æ¡è®°å½•`, 'info');

                // Show sample data - æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
                data.forEach(cat => {
                    const imageCount = cat.images ? cat.images.length : 0;
                    addLog(`çŒ«å’ª #${cat.id} (${cat.name}): ${imageCount} å¼ å›¾ç‰‡`, 'info');
                });

            } catch (error) {
                setStatus('tableStatus', 'âœ— æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
                addLog('è¡¨ç»“æ„æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');

                if (error.message.includes('column') && error.message.includes('images')) {
                    addLog('å¯èƒ½åŸå› : images å­—æ®µä¸å­˜åœ¨', 'error');
                    addLog('è¯·è¿è¡Œ SQL: ALTER TABLE public.cats ADD COLUMN images text[];', 'info');
                }
            }
        }

        // Helper functions - è¾…åŠ©å‡½æ•°
        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status ' + type;
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Event listeners - äº‹ä»¶ç›‘å¬
        document.getElementById('testBucketBtn').addEventListener('click', testBucket);
        document.getElementById('uploadBtn').addEventListener('click', uploadImage);
        document.getElementById('testTableBtn').addEventListener('click', testTable);

        // Initialize on load - é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
